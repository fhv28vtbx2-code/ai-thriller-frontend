<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ò–ó–ò–§ - AI-–¢—Ä–∏–ª–ª–µ—Ä</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Tone.js for sound effects (non-module) -->
    <script src="https://unpkg.com/tone@14.7.58/build/Tone.js"></script>

    <style>
        /* Base styles optimized for dark mode and mobile readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #121212; 
            color: #E0E0E0; 
        }
        .story-container {
            max-height: 50vh; 
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #dc2626 #3f3f46;
        }
        .story-container::-webkit-scrollbar {
            width: 8px;
        }
        .story-container::-webkit-scrollbar-thumb {
            background-color: #dc2626; 
            border-radius: 4px;
        }
        .image-loading {
            background: #272727;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 1; }
        }
        .choice-button {
            transition: all 0.2s;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <!-- Initial Prompt Modal -->
    <div id="initial-prompt-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center hidden">
        <div class="bg-[#1e1e1e] p-8 rounded-2xl max-w-sm w-full shadow-2xl border border-red-700">
            <h2 id="modal-title" class="text-3xl font-bold text-red-500 mb-4">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</h2>
            <p id="modal-text" class="text-gray-400 mb-6">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...</p>
            <div id="modal-actions" class="flex justify-between space-x-4 hidden">
                <button onclick="window.startGame(true); window.closeModal();" class="w-1/2 bg-gray-700 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-200">
                    –ù–æ–≤–∞—è –ò–≥—Ä–∞
                </button>
                <button onclick="window.continueGame(); window.closeModal();" id="continue-button" class="w-1/2 bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition duration-200" disabled>
                    –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å (–•–æ–¥: 1)
                </button>
            </div>
        </div>
    </div>

    <div id="app-container" class="w-full max-w-xl mx-auto bg-[#1a1a1a] rounded-3xl shadow-2xl p-6 sm:p-8 border border-gray-700">

        <header class="text-center mb-6">
            <h1 class="text-4xl sm:text-5xl font-black text-red-500 tracking-wider mb-1">
                –°–ò–ó–ò–§
            </h1>
            <p class="text-sm text-gray-400">AI-–¢—Ä–∏–ª–ª–µ—Ä —Å –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º —Å—é–∂–µ—Ç–æ–º</p>
            <p id="user-info" class="text-xs text-gray-600 mt-2 hidden">UserID: –ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </header>
        
        <!-- Image Container -->
        <div id="image-container" class="mb-6 rounded-2xl overflow-hidden shadow-2xl border border-red-800 aspect-[4/3] bg-gray-800 flex items-center justify-center">
             <div id="image-loader" class="text-center p-8">
                <svg class="animate-spin h-8 w-8 text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm text-gray-400 mt-2">–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–µ—Ç—Å—è –ò–ò...</p>
             </div>
        </div>

        <!-- Story Output Area -->
        <div id="story-output" class="story-container bg-[#272727] p-5 rounded-xl mb-6 border border-gray-700 transition-all duration-300 shadow-inner">
            <p class="text-gray-400">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ Firebase –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞...</p>
        </div>

        <!-- Loading Indicator for Text/Logic -->
        <div id="loading-spinner" class="text-center hidden mb-6">
            <svg class="animate-spin h-8 w-8 text-red-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-sm text-gray-400 mt-2">–ò–ò –æ–±–¥—É–º—ã–≤–∞–µ—Ç —Ç–≤–æ–π —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥...</p>
        </div>

        <!-- Choices Area -->
        <div id="choices-container" class="flex flex-col space-y-3">
            <!-- Buttons will be generated here -->
        </div>

        <!-- Restart Button -->
        <div class="mt-8 text-center">
             <button onclick="window.startGame(true)" id="restart-button" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition duration-300 ease-in-out transform hover:scale-[1.02] active:scale-[0.98] border border-red-900 disabled:opacity-50">
                –ù–∞—á–∞—Ç—å –ù–æ–≤—É—é –ò–≥—Ä—É
            </button>
        </div>

    </div>

    <!-- Firebase Initialization and Game Logic (Module Script) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; // Removed signInWithCustomToken
        import { getFirestore, setLogLevel, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        //                                 –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ë–≠–ö–ï–ù–î–ê
        // =================================================================================
        const BACKEND_URL = 'https://ai-thriller-backend.vercel.app/api/advance-story'; 
        // =================================================================================

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // --- Firebase Config Fix for Mini App ---
        let firebaseConfig = {};
        // Mock/Fallback configuration (used if environment/localStorage fails)
        const MOCK_CONFIG = {
            apiKey: "AIzaSyC_mock_API_Key_for_Standalone_App", // This allows initialization to pass
            authDomain: `${appId}.firebaseapp.com`,
            projectId: appId, 
            storageBucket: `${appId}.appspot.com`,
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:a0b1c2d3e4f5a6b7c8d9e0"
        };

        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                 firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) { console.error("Error parsing environment config."); }
        
        if (Object.keys(firebaseConfig).length === 0) {
            const storedConfig = localStorage.getItem('firebaseConfig');
            if (storedConfig) {
                try {
                    firebaseConfig = JSON.parse(storedConfig);
                } catch(e) { console.error("Error parsing localStorage config."); }
            }
        }

        if (Object.keys(firebaseConfig).length === 0) {
            firebaseConfig = MOCK_CONFIG;
            console.warn("FALLBACK: Using MOCK Firebase config as real config was not found.");
        }
        
        // Initialize Firebase variables
        let app, db, auth;
        window.appId = appId;
        const GAME_COLLECTION = 'game_saves';
        const GAME_DOC_ID = 'thriller_game';
        window.isFirebaseReady = false;
        
        // Expose DOM elements globally for script functions
        const choicesContainer = document.getElementById('choices-container');
        const storyOutput = document.getElementById('story-output');
        const imageContainer = document.getElementById('image-container');
        const imageLoader = document.getElementById('image-loader');
        const loadingSpinner = document.getElementById('loading-spinner');
        const restartButton = document.getElementById('restart-button');
        const userInfo = document.getElementById('user-info');
        
        let chatHistory = [];
        let ambientSynth = null;


        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                
                // IMPORTANT: Store config in localStorage for future Mini App launches
                localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));

                // Sign in logic - SIMPLIFIED TO ANONYMOUS ONLY (The Fix)
                (async () => {
                    await signInAnonymously(auth).then(userCredential => {
                        window.userId = userCredential.user.uid;
                    }).catch(e => {
                        console.error("Anonymous sign in failed:", e);
                    });
                    
                    // Expose Firestore objects globally
                    window.db = db;
                    window.auth = auth;
                    window.doc = doc;
                    window.setDoc = setDoc;
                    window.getDoc = getDoc;
                    window.isFirebaseReady = true; // Set flag to true

                    console.log("Firebase initialized and signed in. User ID:", window.userId);

                    // Start the game flow (loading modal)
                    document.addEventListener('DOMContentLoaded', () => {
                        if (typeof window.showInitialPrompt === 'function') {
                            window.showInitialPrompt();
                        }
                    });

                })();

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('story-output').innerHTML = '<p class="text-red-400">–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase. –ò–≥—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. (–ö–æ–¥ 102)</p>';
            }
        } else {
             // This case should be prevented by the MOCK config fallback
             document.getElementById('story-output').innerHTML = '<p class="text-red-400">–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç. </p>';
        }
        
        
        // --- UTILITY FUNCTIONS ---

        // Waits until Firebase is ready, then executes callback
        function waitForFirebase(callback) {
            if (window.isFirebaseReady) {
                callback();
            } else {
                setTimeout(() => waitForFirebase(callback), 100);
            }
        }
        
        // --- MODAL & INITIAL PROMPT LOGIC ---
        
        window.closeModal = () => {
            document.getElementById('initial-prompt-modal').classList.add('hidden');
        };

        window.showInitialPrompt = async function() {
            waitForFirebase(async () => {
                userInfo.textContent = `UserID: ${window.userId}`;
                userInfo.classList.remove('hidden');

                document.getElementById('initial-prompt-modal').classList.remove('hidden');
                document.getElementById('modal-title').textContent = '–°–ò–ó–ò–§';
                document.getElementById('modal-text').textContent = '–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å...';
                document.getElementById('modal-actions').classList.add('hidden');

                const savedGame = await window.loadGame();
                const modalActions = document.getElementById('modal-actions');
                const continueButton = document.getElementById('continue-button');

                if (savedGame) {
                    try {
                        const historyLength = JSON.parse(savedGame.chatHistoryJSON).length;
                        const turnNumber = Math.ceil(historyLength / 2);
                        
                        document.getElementById('modal-text').textContent = '–ù–∞–π–¥–µ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–∞—è –∏–≥—Ä–∞.';
                        continueButton.textContent = `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å (–•–æ–¥: ${turnNumber})`;
                        continueButton.disabled = false;
                    } catch(e) {
                         // Corrupted save, force new game
                        document.getElementById('modal-text').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É.';
                        continueButton.disabled = true;
                    }

                } else {
                    document.getElementById('modal-text').textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –∏–≥—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ù–∞—á–Ω–∏—Ç–µ –Ω–æ–≤—É—é –∏–≥—Ä—É.';
                    continueButton.disabled = true;
                }
                modalActions.classList.remove('hidden');
            });
        };

        // --- GAME SAVING/LOADING (Firestore) ---

        window.continueGame = function() {
            window.startAudio(); 
            window.loadGame().then(savedGame => {
                if (savedGame) {
                    try {
                        chatHistory = JSON.parse(savedGame.chatHistoryJSON);
                        
                        storyOutput.innerHTML = `<p class="text-gray-300">${savedGame.lastSegment}</p>`;
                        
                        // Call the API to resume the story
                        advanceStory();
                    } catch (e) {
                         // If JSON parse fails, start a new game
                        console.error("Failed to parse saved history, starting new game.");
                        window.startGame(true);
                    }
                } else {
                    window.startGame(true); 
                }
            });
        };
        
        window.loadGame = async function() {
            if (!window.db || !window.userId) return null;
            try {
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'users', window.userId, GAME_COLLECTION, GAME_DOC_ID);
                const docSnap = await window.getDoc(docRef);

                if (docSnap.exists() && docSnap.data().chatHistoryJSON) {
                    return docSnap.data();
                }
            } catch(e) {
                console.error("Error loading game:", e);
            }
            return null;
        };

        async function saveGame(storyData) {
            if (!window.isFirebaseReady || storyData.storySegment.toUpperCase().includes("–ö–û–ù–ï–¶ –ò–ì–†–´:") || !window.db || !window.userId) return;

            const dataToSave = {
                chatHistoryJSON: JSON.stringify(chatHistory),
                lastSegment: storyData.storySegment,
                timestamp: new Date().toISOString()
            };
            
            try {
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'users', window.userId, GAME_COLLECTION, GAME_DOC_ID);
                await window.setDoc(docRef, dataToSave, { merge: true });
            } catch(e) {
                console.error("Error saving game:", e);
            }
        }
        
        // --- AMBIENCE/SOUND LOGIC (Tone.js) ---

        let ambientPart = null;

        window.startAudio = function() {
            if (Tone.context.state !== 'running') {
                Tone.start();
                initAmbiance();
            }
        }

        function initAmbiance() {
            const reverb = new Tone.Reverb({ decay: 5, wet: 0.5 }).toDestination();
            
            ambientSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 4,
                    decay: 0.1,
                    sustain: 1,
                    release: 6
                }
            }).chain(new Tone.Filter(300, "lowpass"), reverb);
        }

        function playAmbiance(context) {
            if (!ambientSynth) return;
            
            let notes = ["C3", "G#3", "D#4"]; 
            let loopTime = "8m"; 

            const lowerCaseContext = context.toLowerCase();
            
            if (lowerCaseContext.includes("–∫—Ä–æ–≤—å") || lowerCaseContext.includes("–æ–ø–∞—Å–Ω–æ") || lowerCaseContext.includes("—Ä–µ–∑–∫")) {
                notes = ["C2", "C#2", "F#2"]; 
                loopTime = "4m";
            } else if (lowerCaseContext.includes("—Å–≤–µ—Ç") || lowerCaseContext.includes("—Å–ø–æ–∫–æ") || lowerCaseContext.includes("—Ä–∞–∑–¥—É–º")) {
                notes = ["C3", "E3", "G3", "A3"]; 
                loopTime = "12m";
            } else if (lowerCaseContext.includes("–∑–∞–ø–µ—Ä—Ç") || lowerCaseContext.includes("—Ç–∞–π–Ω")) {
                notes = ["E3", "G3", "B3", "C4"]; 
                loopTime = "8m";
            }

            Tone.Transport.stop();
            Tone.Transport.clear();

            ambientPart = new Tone.Loop(time => {
                notes.forEach((note, index) => {
                    ambientSynth.triggerAttackRelease(note, "4n", time + index * 0.5);
                });
            }, loopTime);

            Tone.Transport.bpm.value = 40; 
            Tone.Transport.start();
            ambientPart.start(0);
        }

        // --- GAME FLOW LOGIC ---

        window.startGame = function(isRestart = false) {
            window.startAudio(); 
            
            storyOutput.innerHTML = '';
            choicesContainer.innerHTML = '';
            
            if (isRestart) {
                chatHistory = [];
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'users', window.userId, GAME_COLLECTION, GAME_DOC_ID);
                window.setDoc(docRef, { chatHistoryJSON: "[]", lastSegment: "–ù–æ–≤–∞—è –∏–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞", timestamp: new Date().toISOString() });
            }
            
            restartButton.disabled = true;

            const initialPrompt = isRestart
                ? "–ù–∞—á–Ω–∏ —Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ –Ω–æ–≤—É—é, –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—É—é –∏—Å—Ç–æ—Ä–∏—é-—Ç—Ä–∏–ª–ª–µ—Ä —Å –Ω–æ–≤–æ–π —Ç–µ–º–æ–π –∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–º. –£–±–µ–¥–∏—Å—å, —á—Ç–æ —Å—é–∂–µ—Ç –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∏–≥—Ä—ã."
                : "–ù–∞—á–Ω–∏ —Å—é–∂–µ—Ç. –ì–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π –ø—Ä–æ—Å—ã–ø–∞–µ—Ç—Å—è –∏ –æ–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç, —á—Ç–æ —á—Ç–æ-—Ç–æ –≤ –µ–≥–æ –ø—Ä–∏–≤—ã—á–Ω–æ–π –∂–∏–∑–Ω–∏ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å.";

            chatHistory.push({ role: "user", parts: [{ text: initialPrompt }] });

            storyOutput.innerHTML = '<p class="text-red-400 italic">–ù–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏—Å—Ç–æ—Ä–∏—é... –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ.</p>';
            advanceStory();
        };

        window.makeChoice = function(choiceText) {
            storyOutput.innerHTML += `<div class="mt-4 border-t border-gray-800 pt-4"><p class="font-semibold text-red-400">üëâ –í—ã–±–æ—Ä:</p><p class="italic text-gray-300">"${choiceText}"</p></div>`;
            choicesContainer.innerHTML = ''; 
            
            chatHistory.push({ role: "user", parts: [{ text: `–ú–æ–π –≤—ã–±–æ—Ä: ${choiceText}. –ü—Ä–æ–¥–æ–ª–∂–∏ –∏—Å—Ç–æ—Ä–∏—é –∏ –¥–∞–π 3 –Ω–æ–≤—ã—Ö –≤—ã–±–æ—Ä–∞.` }] });

            storyOutput.scrollTop = storyOutput.scrollHeight;

            advanceStory();
        };

        async function advanceStory() {
            loadingSpinner.classList.remove('hidden');
            imageContainer.classList.add('image-loading');
            imageContainer.innerHTML = '';
            imageLoader.classList.remove('hidden');

            
            try {
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chatHistory: chatHistory })
                });

                if (!response.ok) {
                    const errorDetails = await response.json();
                    throw new Error(`Backend Error: ${response.status} - ${errorDetails.error || 'Unknown error'}`);
                }
                
                const data = await response.json();

                updateUI({
                    storySegment: data.storySegment,
                    choices: data.choices
                }, data.imageUrl);
                
                // Add model response to history for next turn
                chatHistory.push({ role: "model", parts: [{ text: JSON.stringify(data) }] });
                
            } catch (error) {
                console.error("Critical error in advanceStory (Backend):", error);
                storyOutput.innerHTML += `<p class="text-red-500 mt-4">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ü—Ä–æ–±–ª–µ–º–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º (${error.message}). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.</p>`;
                restartButton.disabled = false;
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        }

        function updateUI(storyData, imageUrl) {
            loadingSpinner.classList.add('hidden');

            const newSegment = storyData.storySegment.trim();
            const choices = Array.isArray(storyData.choices) ? storyData.choices : [];
            
            // UI Improvement: Use lighter text for the story output
            storyOutput.innerHTML += `<div class="mt-6 border-t border-gray-800 pt-4"><p class="text-gray-200">${newSegment}</p></div>`;

            storyOutput.scrollTop = storyOutput.scrollHeight;

            if (imageUrl) {
                displayIllustration(imageUrl);
                playAmbiance(newSegment);
            } else {
                 imageContainer.innerHTML = `<p class="text-sm text-gray-500 p-4">–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞.</p>`;
            }

            const isGameOver = newSegment.toUpperCase().includes("–ö–û–ù–ï–¶ –ò–ì–†–´:") || choices.length === 0;

            if (isGameOver) {
                choicesContainer.innerHTML = `<p class="text-center text-xl text-red-500 font-bold mt-4">*** –ö–û–ù–ï–¶ –ò–°–¢–û–†–ò–ò ***</p>`;
                restartButton.disabled = false;
                Tone.Transport.stop(); 
                const docRef = window.doc(window.db, 'artifacts', window.appId, 'users', window.userId, GAME_COLLECTION, GAME_DOC_ID);
                window.setDoc(docRef, { chatHistoryJSON: "[]", lastSegment: "–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞", timestamp: new Date().toISOString() });

            } else {
                choicesContainer.innerHTML = '';
                choices.forEach((choice, index) => {
                    if (index < 3) { 
                        const button = document.createElement('button');
                        // UI Improvement: Enhanced button style
                        button.className = 'choice-button bg-[#272727] hover:bg-red-800 text-gray-100 font-medium py-3 px-4 rounded-xl shadow-md transition duration-200 ease-in-out text-left border border-red-700/50 hover:border-red-500';
                        button.textContent = `${index + 1}. ${choice.trim()}`;
                        button.onclick = () => window.makeChoice(choice.trim());
                        choicesContainer.appendChild(button);
                    }
                });

                saveGame(storyData); 
            }
        }

        function displayIllustration(imageUrl) {
            imageContainer.classList.remove('image-loading');
            imageLoader.classList.add('hidden');
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = "–ò–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è –∫ –∏—Å—Ç–æ—Ä–∏–∏";
            img.className = 'w-full h-full object-cover rounded-2xl';
            
            imageContainer.innerHTML = '';
            imageContainer.appendChild(img);
        }

        
    </script>
</body>
</html>
